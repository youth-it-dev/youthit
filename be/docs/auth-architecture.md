# 인증 아키텍처 플로우

## 기술 스택
- **프론트엔드**: Firebase Client SDK
- **백엔드**: Firebase Admin SDK
- **소셜 로그인**: 카카오 OpenID Connect (OIDC)
- **인증 방식**: Firebase ID Token (Bearer Token)

---

## 1. 카카오 로그인 플로우

### 신규 회원 플로우

```text
사용자 → 카카오 로그인 버튼 클릭
  ↓
카카오 인증 완료
  ↓
Firebase Auth 사용자 생성
  ↓
사용자 기본 정보 생성
  ↓
온보딩 페이지로 이동
  ↓
온보딩 페이지에서:
  1. 카카오 프로필 정보 동기화
  2. 닉네임 설정
  3. 프로필 완료
```

### 기존 회원 플로우

```text
사용자 → 카카오 로그인
  ↓
Firebase Auth 로그인
  ↓
사용자 정보 확인
  ↓
닉네임 없음 → 온보딩 페이지로 이동
닉네임 있음 → 정상 라우팅
```

---

## 2. 백엔드 인증 가드

모든 보호된 API는 인증 미들웨어로 검증합니다.

```text
1. Authorization 헤더에서 Bearer 토큰 추출
2. Firebase Admin SDK로 ID 토큰 검증
3. 로그아웃된 토큰 거부
4. 자격정지 상태 확인
5. 사용자 정보 저장
```

---

## 3. 카카오 프로필 동기화

신규 회원 온보딩 시 카카오 프로필 정보를 동기화합니다.

### 동기화 프로세스

```text
1. 카카오 API 호출
2. 데이터 정규화 (전화번호, 생년월일 등)
3. 약관 정보 처리
4. 사용자 정보 업데이트
```

### 동기화 실패 처리

온보딩 페이지에서 동기화 실패 시:
- 에러 안내 모달 표시
- 사용자가 재시도 가능
- 나중에 마이페이지에서 프로필 수정 가능

### 온보딩 미완료 사용자 처리

로그인 시 닉네임이 없는 경우 자동으로 온보딩 페이지로 리다이렉트됩니다.

---

## 4. 로그아웃 / 회원 탈퇴

**로그아웃**:
```text
1. 모든 Refresh Token 무효화
2. 로컬 세션 정리
```

**회원 탈퇴**:
```text
1. 카카오 재인증
2. 카카오 연결 해제
3. 개인정보 가명처리 (생년월일만 부분 보존)
4. Firebase Auth 사용자 삭제
5. 로컬 세션 정리
```

---

## 5. 토큰 관리

- **Firebase ID Token**: API 요청 시 사용
- **Firebase Refresh Token**: ID Token 자동 갱신용
- **카카오 Access Token**: 프로필 동기화 시에만 사용 후 폐기

로그아웃 시 모든 Refresh Token이 무효화되며, 무효화된 토큰은 자동으로 거부됩니다.
